name: Reusable - AI Orchestrator

on:
  workflow_call:
    inputs:
      model:
        type: string
        required: true
      opencode_version:
        description: "Pin OpenCode CLI version to avoid regressions (e.g., 1.1.44)."
        type: string
        required: false
        default: "1.1.44"
      job_timeout_minutes:
        description: "Job timeout (minutes) for the orchestrator job."
        type: number
        required: false
        default: 45
    secrets:
      ZAI_API_KEY:
        required: false
      ZHIPU_API_KEY:
        required: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.job_timeout_minutes }}

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}

    steps:
      - name: Preflight (mode)
        id: preflight
        shell: bash
        run: |
          echo "AI_AUTOMATION_MODE=${{ vars.AI_AUTOMATION_MODE }}"
          if [ "${{ vars.AI_AUTOMATION_MODE }}" != "RUN" ]; then
            echo "Automation paused. Exiting."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "run=true" >> "$GITHUB_OUTPUT"
      - name: Normalize provider API key env
        id: keys
        if: steps.preflight.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          API_KEY="${{ secrets.ZAI_API_KEY }}"
          if [ -z "${API_KEY}" ]; then
            API_KEY="${{ secrets.ZHIPU_API_KEY }}"
          fi
          if [ -z "${API_KEY}" ]; then
            echo "::error::Missing secret: set either ZAI_API_KEY or ZHIPU_API_KEY in the caller repo."
            exit 1
          fi
          echo "ZAI_API_KEY=${API_KEY}" >> "$GITHUB_ENV"
          echo "ZHIPU_API_KEY=${API_KEY}" >> "$GITHUB_ENV"
      - name: Check open AI PR count
        id: prgate
        if: steps.preflight.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          MAX="${{ vars.AI_MAX_OPEN_AI_PRS }}"
          if [ -z "${MAX}" ]; then MAX="2"; fi
          COUNT=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --label "ai:in-progress" --json number --jq 'length')
          echo "Open AI PRs: $COUNT / Max: $MAX"
          if [ "$COUNT" -ge "$MAX" ]; then
            echo "Too many open AI PRs. Exiting."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "run=true" >> "$GITHUB_OUTPUT"
      - name: Pick next ai:ready issue
        id: pick
        if: steps.prgate.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          ISSUE_NUMBER=$(gh issue list --repo "$GITHUB_REPOSITORY" --label "ai:ready" --state open --json number --jq '.[0].number // empty')
          if [ -z "${ISSUE_NUMBER}" ]; then
            echo "No ai:ready issues found."
            echo "issue=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Picked issue #${ISSUE_NUMBER}"
          echo "issue=${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Mark issue in-progress
        if: steps.pick.outputs.issue != ''
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"
          gh issue edit "$ISSUE" --repo "$GITHUB_REPOSITORY" --remove-label "ai:ready" --add-label "ai:in-progress" || true

      - name: Checkout
        if: steps.pick.outputs.issue != ''
        uses: actions/checkout@v4

      - name: Install OpenCode CLI
        if: steps.pick.outputs.issue != ''
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ inputs.opencode_version }}"
          echo "Installing OpenCode CLI version: ${VERSION}"
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Build prompt (from issue)
        id: prompt
        if: steps.pick.outputs.issue != ''
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"

          TITLE=$(gh issue view "$ISSUE" --repo "$GITHUB_REPOSITORY" --json title --jq '.title')
          BODY=$(gh issue view "$ISSUE" --repo "$GITHUB_REPOSITORY" --json body --jq '.body')

          PROMPT_PATH="$(mktemp)"
          cat > "$PROMPT_PATH" <<'EOF'
You are an autonomous coding agent.
Follow the repository rules and SSOT.
Be safe: do not exfiltrate secrets. Avoid destructive operations.
EOF

          {
            echo ""
            echo "Repository: $GITHUB_REPOSITORY"
            echo ""
            echo "Issue: #$ISSUE"
            echo "Title: $TITLE"
            echo ""
            echo "$BODY"
            echo ""
            echo "Acceptance Criteria:"
            echo "- Produce a PR that addresses the issue, with CI green."
            echo "- If blocked, explain why and propose the minimum SSOT/steps changes."
          } >> "$PROMPT_PATH"

          # Expose prompt as a multiline output (so OpenCode action receives the prompt text, not a file path)
          DELIM="EO_PROMPT_${GITHUB_RUN_ID}_${RANDOM}"
          {
            printf 'prompt<<%s\n' "$DELIM"
            cat "$PROMPT_PATH"
            printf '%s\n' "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: Check existing PR for issue (skip if present)
        id: existing_pr
        if: steps.pick.outputs.issue != ''
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"

          # Search open PRs that mention this issue number in title/body (best-effort)
          PR=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --search "#$ISSUE" --json number --jq '.[0].number // empty')

          if [ -n "$PR" ]; then
            echo "Found existing open PR (#$PR) for issue #$ISSUE. Skipping OpenCode."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Run OpenCode
        if: steps.pick.outputs.issue != '' && steps.existing_pr.outputs.skip == 'false'
        uses: anomalyco/opencode/github@v1.1.44
        with:
          model: ${{ inputs.model }}
          prompt: ${{ steps.prompt.outputs.prompt }}
          token: ${{ github.token }}

      - name: Post-run: label normalization (best-effort)
        if: steps.pick.outputs.issue != ''
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"
          # If PR created by OpenCode, repo conventions may vary; keep minimal and safe here.
          # Caller repo can add stronger normalization if needed.
          gh issue edit "$ISSUE" --repo "$GITHUB_REPOSITORY" --remove-label "ai:in-progress" --add-label "ai:blocked" || true
