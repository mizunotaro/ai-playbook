name: Reusable - AI Orchestrator

on:
  workflow_call:
    inputs:
      model:
        type: string
        required: true
    secrets:
      ZAI_API_KEY:
        required: false
      ZHIPU_API_KEY:
        required: false

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write

    env:
      GH_TOKEN: ${{ github.token }}
      GH_REPO: ${{ github.repository }}

    steps:
      - name: Preflight (mode)
        id: preflight
        shell: bash
        run: |
          echo "AI_AUTOMATION_MODE=${{ vars.AI_AUTOMATION_MODE }}"
          if [ "${{ vars.AI_AUTOMATION_MODE }}" != "RUN" ]; then
            echo "Automation paused. Exiting."
            echo "run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "run=true" >> "$GITHUB_OUTPUT"

      - name: Normalize provider API key env
        id: keys
        if: steps.preflight.outputs.run == 'true'
        shell: bash
        run: |
          set -euo pipefail
          API_KEY="${{ secrets.ZAI_API_KEY }}"
          if [ -z "${API_KEY}" ]; then
            API_KEY="${{ secrets.ZHIPU_API_KEY }}"
          fi
          if [ -z "${API_KEY}" ]; then
            echo "::error::Missing secret: set either ZAI_API_KEY or ZHIPU_API_KEY in the caller repo."
            exit 1
          fi
          echo "ZAI_API_KEY=${API_KEY}" >> "$GITHUB_ENV"
          echo "ZHIPU_API_KEY=${API_KEY}" >> "$GITHUB_ENV"

      - name: Check open AI PR count
        id: prgate
        if: steps.preflight.outputs.run == 'true'
        shell: bash
        run: |
          MAX="${{ vars.AI_MAX_OPEN_AI_PRS }}"
          [ -z "$MAX" ] && MAX="1"
          OPEN_AI_PRS=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --label "ai:in-progress" --json number --jq 'length')
          echo "OPEN_AI_PRS=$OPEN_AI_PRS MAX=$MAX"
          if [ "$OPEN_AI_PRS" -ge "$MAX" ]; then
            echo "Too many open AI PRs. Exiting."
            echo "proceed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "proceed=true" >> "$GITHUB_OUTPUT"

      - name: Checkout
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Remove checkout auth header (avoid duplicate Authorization)
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true'
        shell: bash
        run: |
          git config --local --unset-all http.https://github.com/.extraheader || true
          git config --global --unset-all http.https://github.com/.extraheader || true

      - name: Pick next issue from queue
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true'
        id: pick
        shell: bash
        run: |
          ISSUE=$(gh api -X GET search/issues             -f q="repo:${GITHUB_REPOSITORY} is:issue is:open label:ai:ready -label:ai:blocked -label:ai:pr-open sort:created-asc"             --jq '.items[0].number // empty')
          echo "issue=$ISSUE" >> "$GITHUB_OUTPUT"
          if [ -z "$ISSUE" ]; then
            echo "No queued issues."
            exit 0
          fi
          gh issue edit --repo "$GITHUB_REPOSITORY" "$ISSUE" --remove-label "ai:ready" --add-label "ai:in-progress"

      - name: Skip if an open PR already references this issue
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true' && steps.pick.outputs.issue != ''
        id: existing_pr
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"

          # If an open PR already references this Issue number, don't re-run the agent.
          PRS_JSON=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --json number,title,body)
          PR=$(echo "$PRS_JSON" | jq -r --arg issue "$ISSUE" 'map(select((.title + "\n" + (.body // "")) | test("#" + $issue; "i"))) | .[0].number // empty')

          if [ -n "$PR" ]; then
            echo "Found existing open PR #$PR for Issue #$ISSUE. Skipping."
            gh issue comment --repo "$GITHUB_REPOSITORY" "$ISSUE" --body "Open PR #$PR already references this issue. Marking as ai:pr-open to prevent re-run."
          gh issue edit --repo "$GITHUB_REPOSITORY" "$ISSUE" --remove-label "ai:in-progress" --add-label "ai:pr-open"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Build prompt (workspace + git-exclude)
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true' && steps.pick.outputs.issue != ''
        id: prompt
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"
          TITLE=$(gh issue view --repo "$GITHUB_REPOSITORY" "$ISSUE" --json title --jq '.title')
          BODY=$(gh issue view --repo "$GITHUB_REPOSITORY" "$ISSUE" --json body --jq '.body' | head -c 12000)

          # Put prompt in workspace (some agent toolchains can't read outside workspace),
          # but make sure it can never show up in git status / commits.
          PROMPT_DIR="${RUNNER_TEMP}/opencode"
          mkdir -p "$PROMPT_DIR"
          PROMPT_PATH="$PROMPT_DIR/PROMPT.txt"

          cat > "$PROMPT_PATH" << 'EOF'
          You are the Implementation Agent.

          NON-NEGOTIABLE GUARDRAILS:
          - Do NOT change dependencies unless the issue has label "ai:deps".
          - Keep the diff minimal. Avoid broad refactors.
          - Add/adjust tests if applicable.
          - Do not edit secrets, CI credentials, or security-sensitive configs.
          - Work on the CURRENTLY CHECKED-OUT BRANCH (do NOT create/switch branches).
          - Do NOT run `git checkout -b` or change the branch name.
          - Do NOT run `gh pr create` / `gh pr edit`. The OpenCode runner will create/update the PR.
          - Do NOT `git push`. Commit only; the runner will push.
          - If the task is ambiguous, STOP and write a short question in the PR description.

          COMMIT MESSAGE FORMAT (EN + JP):
          - First line: conventional commit in English
          - Second line: Japanese summary

          TASK:
          EOF

          echo "Work on GitHub Issue #$ISSUE: $TITLE" >> "$PROMPT_PATH"
          echo "" >> "$PROMPT_PATH"
          echo "Issue body (truncated):" >> "$PROMPT_PATH"
          echo "$BODY" >> "$PROMPT_PATH"
          echo "" >> "$PROMPT_PATH"
          echo "Deliverable: commit the minimal changes on the current branch; OpenCode will create the PR automatically. Ensure the PR description references (e.g., \"Closes #$ISSUE\")." >> "$PROMPT_PATH"

          echo "path=$PROMPT_PATH" >> "$GITHUB_OUTPUT"

      - name: Run OpenCode
        id: oc
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true' && steps.pick.outputs.issue != ''
        continue-on-error: true
        uses: anomalyco/opencode/github@latest
        with:
          model: ${{ inputs.model }}
          prompt: ${{ steps.prompt.outputs.path }}


      - name: Normalize Issue label to ai:pr-open on successful PR creation
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true' && steps.pick.outputs.issue != '' && steps.oc.outcome == 'success'
        shell: bash
        run: |
          set -euo pipefail
          ISSUE="${{ steps.pick.outputs.issue }}"

          # Find an open PR that references this issue number (e.g., "Closes #<ISSUE>").
          PR="$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --json number,title,body --jq             ".[] | select((.title + "\n" + (.body // "")) | test(\"(^|[^0-9])#${ISSUE}([^0-9]|$)\"); \"i\")) | .number"             | head -n 1)"

          if [ -z "${PR:-}" ]; then
            echo "No open PR references issue #$ISSUE; leaving labels unchanged."
            exit 0
          fi

          if gh issue edit --repo "$GITHUB_REPOSITORY" "$ISSUE" --remove-label "ai:in-progress" --add-label "ai:pr-open"; then
            gh issue comment --repo "$GITHUB_REPOSITORY" "$ISSUE" --body "PR #$PR is open for this issue. Normalized label to \`ai:pr-open\`."
          else
            echo "::warning::Failed to set ai:pr-open (label may not exist)."
          fi
      - name: Revert issue label and fail if OpenCode failed
        if: steps.preflight.outputs.run == 'true' && steps.prgate.outputs.proceed == 'true' && steps.pick.outputs.issue != '' && steps.oc.outcome != 'success'
        shell: bash
        run: |
          ISSUE="${{ steps.pick.outputs.issue }}"
          gh issue edit --repo "$GITHUB_REPOSITORY" "$ISSUE" --remove-label "ai:in-progress" --add-label "ai:ready"
          echo "::error::OpenCode failed. Reverted Issue #$ISSUE label back to ai:ready."
          exit 1
